<!DOCTYPE html>
<html>
<head>
    <style>
        .popup-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 500px;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .popup-row {
            margin-bottom: 25px;
        }

        .popup-button {
            padding: 10px;
            background-color: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .popup-table {
            border-collapse: collapse;
            width: 100%;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even){background-color: #f2f2f2}

        th {
            background-color: #D22B2B;
            color: white;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
        function deleteUser(userID) {
            // Add logic to handle delete action for the user with the specified ID
            if (userID === 1) {
                alert("You can't delete admin.");
            } else {
                alert("Delete user with ID: " + userID);
                $.ajax({
                    method: "GET",
                    url: "/remove",
                    data: { userID: userID },
                    success: function(response) {
                        alert("User with ID " + userID + " removed successfully!");
                        // Update the table with the new data
                        $('#usr'+userID).remove();
                    },
                    error: function() {
                        alert("An error occurred while removing the user.");
                    }
                });
            }
        }
    </script>
</head>
<body>

<h2>Z√°vady üöé</h2><br>

<select name="failures" id="failures">
    <option value="all">All</option>
    <option value="tbd">To be done</option>
    <option value="wip">Work in progress</option>
    <option value="done">Done</option>
</select>

<table id="table-zavady">
    <tr>
        <th>ID</th>
        <th>SPZ</th>
        <th>Autor</th>
        <th>Technik</th>
        <th>Popis</th>
        <th>Stav</th>
        <th>Upravit</th>
        <th>Vy≈ôe≈°eno</th>
    </tr>

    {{range .}}
        <tr id="failure{{.FailureID}}">
            <td id="failureID{{.FailureID}}">{{.FailureID}}</td>
            <td id="spz{{.FailureID}}">{{.SPZ}}</td>
            <td id="authorSurname{{.FailureID}}">{{.AuthorSurname}}</td>
            <td id="technicianSurname{{.FailureID}}">{{.TechnicianSurname}}</td>
            <td id="description{{.FailureID}}">{{.Description}}</td>
            <td id="state{{.FailureID}}">{{.State}}</td>
            <td><button class="edit-btn" onclick="editFail({{.FailureID}})">‚úèÔ∏è</button></td>
            <td><button class="done-btn" onclick="doneFail({{.FailureID}})">‚úÖ</button></td>
        </tr>

        <script>

            document.getElementById("editFail" + {{.FailureID}}).onclick = function() {
                editFail(id);
                //zmenit text na buttone na ‚úÖ
            }

            document.getElementById("doneFail" + {{.FailureID}}).onclick = function() {
                doneFail(id);
            }

            function doneFail(id) {
                //change state to "Vy≈ôe≈°eno" v DB
            }

            function editFail(id) {
                var spz = document.getElementById("spz" + id);
                var authorSurname = document.getElementById("authorSurname" + id);
                var technicianSurname = document.getElementById("technicianSurname" + id);
                var description = document.getElementById("description" + id);
                var state = document.getElementById("state" + id);

                spz.innerHTML = '<input type="text" value="' + spz.innerHTML + '">';
                authorSurname.innerHTML = '<input type="text" value="' + authorSurname.innerHTML + '">';
                technicianSurname.innerHTML = '<input type="text" value="' + technicianSurname.innerHTML + '">';
                description.innerHTML = '<input type="text" value="' + description.innerHTML + '">';
                state.innerHTML = '<input type="text" value="' + state.innerHTML + '">';

                document.getElementById("editFail" + id).onclick = function() {
                    changeEditState(id);
                }
            }

            function changeEditState(id){
                //zmeni≈• hodnoty v db
                //sp√§≈• na default zobrazenie (bez textfieldu)
            }

        </script>

    {{end}}
</table>
<br>

<button class="create-failure" onclick="openPopupFailures()">‚ûï</button>

<div id="popup" class="popup-container">
    <p>Vytvori≈• nov√∫ z√°vadu</p>
    <div class="popup-row">
        <label for="spzInput">SPZ:</label>
        <input type="text" id="spzInput" list="spzSuggestions" placeholder="Enter vehicle SPZ" value="" onblur="validateSpz(this.value)" oninput="updateSuggestions(this)">
        <datalist id="spzSuggestions">
        </datalist>
        <label for="spzInput" id="spzInputStatus">‚ùå</label>
    </div>

    <div class="popup-row">
        <label for="technicianInput">Technik:</label>
        <select id="technicianInput">

        </select>
    </div>

    <div class="popup-row">
        <label for="descriptionInput">Popis:</label><br>
        <textarea id="descriptionInput" placeholder="TODO"></textarea>
    </div>

    <div class="popup-row">
        <label for="stateInput">Souƒçasn√Ω stav:</label>
        <select>
            <option value="P≈ôideleno">P≈ôideleno</option>
            <option value="vreseni">V ≈ôe≈°en√≠</option>
            <option value="pozastaveno">Pozastaveno</option>
            <option value="vyreseno">Vy≈ôe≈°eno</option>
        </select>
    </div>

    <button onclick="closePopupFailures()">Zru≈°it</button>
    <button id="create-btn" onclick="create()">Vytvori≈• z√°vadu</button>
</div>

<div id="overlay" class="overlay"></div>

<script>
    let spzData = [];
    let technicianData = [];

    function openPopupFailures() {
        document.getElementById('popup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        select = document.getElementById('technicianInput')
        var index = 0
        technicianData.forEach(function (technician) {
            console.log(index)
            var option = document.createElement('option')
            option.value = technician["Name"] + " " + technician["Surname"]
            option.innerHTML = technician["Name"] + " " + technician["Surname"]
            select.appendChild(option)
            index++
        })
    }

    function closePopupFailures() {
        document.getElementById('popup').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function create() {
        spz = document.getElementById("spzInput").value
        date = document.getElementById("dateInput").value
        details = document.getElementById("detailsInput").value

        console.log("SPZ: " + spz)
        console.log("Date: " + date)
        console.log("Details: " + details)
        document.getElementById('popup').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function fetchData() {
        fetch('/get-spzs')
            .then(response => response.json())
            .then(data => {
                spzData = data
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    function updateSuggestions(input) {
        var inputValue = input.value.toLowerCase();
        var dataList = document.getElementById('spzSuggestions');

        dataList.innerHTML = '';

        var filteredSuggestions = spzData.filter(function (suggestion) {
            return suggestion.toLowerCase().includes(inputValue);
        });

        filteredSuggestions.forEach(function (suggestion) {
            var option = document.createElement('option');
            option.value = suggestion;
            dataList.appendChild(option);
        });
    }

    function validateSpz(input) {
        $.ajax({
            method: "GET",
            url: "/spz-exists",
            data: { SPZ: input },
            success: function(response) {
                if(response === true) {
                    document.getElementById("spzInputStatus").innerHTML = "‚úÖ"
                } else if(response === false) {
                    document.getElementById("spzInputStatus").innerHTML = "‚ùå"
                }
            },
            error: function() {
                console.log("ERROR")
            }
        });
    }

    function resizePopupToContent(rows) {
        let popup = document.getElementById('popup');
        let pixels = 450 + rows * 40
        popup.style.height = pixels.toString() + 'px';
    }

    function getTechnicians(){
        fetch('/get-technicians')
            .then(response => response.json())
            .then(data => {
                technicianData = data
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    fetchData();
    getTechnicians();

</script>

</body>
</html>