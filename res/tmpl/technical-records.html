<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Technick√© z√°znamy</title>
    <style>
        .popup-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 450px;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .popup-row {
            margin-bottom: 25px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even){background-color: #f2f2f2}

        th {
            background-color: #D22B2B;
            color: white;
        }

        .popup-button-cancel {
            padding: 10px;
            background-color: #dd1115;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .popup-button-create {
            margin-top: 10px;
            margin-left: 100px;
            padding: 10px;
            background-color: #00990c ;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .details-input {
            width: 400px;
            height: 150px;
            text-align: start;
        }

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
    </script>
</head>
<body>
<h2>Technick√© z√°znamy üöé</h2><br>

<select name="failures" id="failures">
    <option value="all">All</option>
    <option value="tbd">To be done</option>
    <option value="wip">Work in progress</option>
    <option value="done">Done</option>
</select>

<table id="technical-records">
    <thead>
        <tr>
            <th>SPZ</th>
            <th>D√°tum</th>
            <th>Z√°vady</th>
            <th>Detaily</th>
            <th>Author</th>
            <th>Upravit</th>
        </tr>
    </thead>
    <tbody id="tech-records-tbody">
    {{range .}}
        <tr id="tech-record{{.ID}}">
            <td id="spz{{.ID}}">{{.SPZ}}</td>
            <td id="date{{.ID}}">{{.Date}}</td>
            {{if not .Failures}}
                <td id="failureID{{.ID}}">Ziadne</td>
            {{else}}
                {{range $index, $value := .Failures}}
                    <td id="failureID{{$value.FailureID}}">{{$value.Description}}</td>
                {{end}}
            {{end}}
            <td id="details{{.ID}}">{{.Details}}</td>
            <td id="author{{.ID}}">{{.AuthorName}} {{.AuthorSurname}}</td>
            <td><button id="editButton{{.ID}}" class="edit-btn" onclick="editTechRec({{.ID}})">‚úèÔ∏è</button></td>
        </tr>
    {{end}}
    </tbody>
</table>
<br>

<button class="create-tech-record" onclick="openPopup()">‚ûï</button>

<div id="popup" class="popup-container">
    <p>Create new technical record</p>
    <div class="popup-row">
        <label for="spzInput">SPZ:</label>
        <input type="text" id="spzInput" list="spzSuggestions" placeholder="Enter vehicle SPZ" value="" onblur="validateSpz(this.value)" oninput="updateSuggestions(this)">
        <datalist id="spzSuggestions">
        </datalist>
        <label for="spzInput" id="spzInputStatus">‚ùå</label>
    </div>
    <div class="popup-row">
        <label for="dateInput">Date:</label>
        <input type="date" id="dateInput" onblur="validateDate(this.value)">
        <label for="dateInput" id="dateInputStatus">‚úÖ</label>

        <script>
            function getTodayDate() {
                const today = new Date();
                const day = today.getDate().toString().padStart(2, '0');
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const year = today.getFullYear();
                return `${year}-${month}-${day}`;
            }

            document.getElementById('dateInput').value = getTodayDate();

            function validateDate(date) {
                console.log('Validating date:', date);
            }
        </script>

    </div>
    <div id="tableContainer" class="popup-row">
        <label for="failure-table">Failures:</label>
        <table id="failure-table">
            <thead>
            <tr>
                <th>Details</th>
                <th>Assign</th>
            </tr>
            </thead>
            <tbody id="failure-table-body">
            </tbody>
        </table>
    </div>
    <div>
        <label id="detailsInputStatus" for="detailsInput">‚ùå</label>
        <label for="detailsInput">Details:</label>
        <textarea onblur="validateDetails(this.value)" id="detailsInput" class="details-input"></textarea>
    </div>
    <button onclick="closePopup()" class="popup-button-cancel">Close</button>
    <button id="create-btn" onclick="create()" class="popup-button-create">Create</button>
</div>

<div id="overlay" class="overlay"></div>

<script>
    let spzData = [];
    let failures = 0;
    let failuresIDs = [];
    let fails = [];
    let valid = false;
    let validDate = false;
    let validDetails = false;
    let userID = 0;
    let userName = "";
    let userSurname = "";

    function editTechRec(id) {
        document.getElementById("editButton" + id).textContent = "‚úÖ";
        document.getElementById("editButton" + id).insertAdjacentHTML('afterend', '&nbsp;<button id="deleteButton' + id + '" class="delete-btn" onclick="deleteFail(' + id + ')">‚ùå</button>');

        var spz = document.getElementById("spz" + id);
        var detail = document.getElementById("details" + id);

        var spzValue = spz.innerText
        var detailValue = detail.innerText


        document.getElementById("editButton" + id).onclick = function() {
            changeEditTechRec(id)
        }

        sugTarget = "newSpzSuggestion" + id
        verTarget = "newSpzInputStatus" + id

        spz.innerHTML = '<input id="editSpz' + id + '" type="text" value="' + spzValue + '" list="newSpzSuggestion' + id + '" oninput="updateSuggestionsForTarget(this,'+sugTarget+')" onblur="validateSpzForTarget(this.value,'+verTarget+')">' +
            '<datalist id="newSpzSuggestion' + id + '"></datalist>'
            + '<label for="editSpz' + id + '" id="newSpzInputStatus' + id + '">‚ùå</label>'
        detail.innerHTML = '<input id="editDetail' + id + '" type="text" value="' + detailValue + '">';

    }

    function changeEditTechRec(id){
        document.getElementById("editButton" + id).textContent = "‚úèÔ∏è";

        var deleteButton = document.getElementById("deleteButton" + id);
        if (deleteButton) {
            deleteButton.remove();
        }

        document.getElementById("editButton" + id).onclick = function() {
            editTechRec(id)
        }

        var spz = document.getElementById("spz" + id);
        var detail = document.getElementById("details" + id);

        var newSpz = document.getElementById("editSpz" + id);
        var newDetail = document.getElementById("editDetail" + id); //chyba

        spz.innerHTML = newSpz.value
        detail.innerHTML = newDetail.value
    }

    function updateSuggestionsForTarget(input, target) {
        var inputValue = input.value.toLowerCase();
        target.innerHTML = '';

        var filteredSuggestions = spzData.filter(function (suggestion) {
            return suggestion.toLowerCase().includes(inputValue);
        });

        filteredSuggestions.forEach(function (suggestion) {
            var option = document.createElement('option');
            option.value = suggestion;
            target.appendChild(option);
        });
    }

    function validateSpzForTarget(input, target) {
        $.ajax({
            method: "GET",
            url: "/spz-exists",
            data: { SPZ: input },
            success: function(response) {
                if(response === true) {
                    target.innerHTML = "‚úÖ";
                } else if(response === false) {
                    target.innerHTML = "‚ùå";
                }
            },
            error: function() {
                console.log("ERROR");
            }
        });
    }

    function openPopup() {
        document.getElementById('popup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function closePopup() {
        clearInputs()
        document.getElementById('popup').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function clearInputs() {
        document.getElementById('spzInput').value = ''
        document.getElementById('dateInput').value = ''
        document.getElementById('detailsInput').value = ''
        document.getElementById("failure-table-body").innerHTML = ''
        document.getElementById("spzInputStatus").innerHTML = "‚ùå"
        document.getElementById("dateInputStatus").innerHTML = "‚ùå"
        document.getElementById("detailsInputStatus").innerHTML = "‚ùå"
    }

    function create() {
        spz = document.getElementById("spzInput").value
        date = document.getElementById("dateInput").value
        details = document.getElementById("detailsInput").value

        $.ajax({
            method: "GET",
            url: "/get-actual-user",
            success: function(response) {
                userID = response["ID"]
                userName = response["Name"]
                userSurname = response["Surname"]

                var i = 0
                var assignedFailures = []
                var assignedFailuresDetails = []


                while (i < failures) {
                    var val = document.getElementById('ch' + i).checked
                    console.log("Checkbox" + i + ": " + val)
                    if (val === true) {
                        assignedFailures.push(failuresIDs[i])
                        assignedFailuresDetails.push(fails[i])
                    }
                    i++
                }

                console.log("SPZ: " + spz)
                console.log("Date: " + date)
                console.log("Details: " + details)
                console.log("AssignedFailures: " + assignedFailures)

                $(document).ready(function () {
                    var requestData = {
                        SPZ: spz,
                        Date: date,
                        FailureID : assignedFailures[0],
                        FailureDescription : assignedFailuresDetails[0],
                        Details : details,
                        AuthorID : userID,
                        AuthorName : userName,
                        AuthorSurname : userSurname,
                    };

                    $.ajax({
                        type: "POST",
                        url: "/create-new-tech-record",
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(requestData),
                        success: function (response) {
                            console.log("Response from Go server:", response);
                            updateTable(response)
                        },
                        error: function (error) {
                            console.error("Error:", error);
                        }
                    });
                });
                clearInputs()
                document.getElementById('popup').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            },
            error: function() {
                console.log("ERROR")
            }
        });
    }

    function fetchData() {
        fetch('/get-spzs')
            .then(response => response.json())
            .then(data => {
                spzData = data
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    function validateDate(date) {
        if(date === "") {
            console.log("Empty date")
            document.getElementById("dateInputStatus").innerHTML = "‚ùå"
            validDate = false
        } else {
            console.log(date)
            document.getElementById("dateInputStatus").innerHTML = "‚úÖ"
            validDate = true
        }
    }

    function validateDetails(details) {
        if(details === "") {
            console.log("Empty date")
            document.getElementById("detailsInputStatus").innerHTML = "‚ùå"
            validDetails = false
        } else {
            console.log(details)
            document.getElementById("detailsInputStatus").innerHTML = "‚úÖ"
            validDetails = true
        }
    }

    function updateSuggestions(input) {
        var inputValue = input.value.toLowerCase();
        var dataList = document.getElementById('spzSuggestions');

        dataList.innerHTML = '';

        var filteredSuggestions = spzData.filter(function (suggestion) {
            return suggestion.toLowerCase().includes(inputValue);
        });

        filteredSuggestions.forEach(function (suggestion) {
            var option = document.createElement('option');
            option.value = suggestion;
            dataList.appendChild(option);
        });
    }

    function validateSpz(input) {
        $.ajax({
            method: "GET",
            url: "/spz-exists",
            data: { SPZ: input },
            success: function(response) {
                if(response === true) {
                    document.getElementById("spzInputStatus").innerHTML = "‚úÖ"
                    valid = true
                    getFailuresForVehicle(input)
                } else if(response === false) {
                    document.getElementById("spzInputStatus").innerHTML = "‚ùå"
                }
            },
            error: function() {
                console.log("ERROR")
            }
        });
    }

    function getFailuresForVehicle(SPZ) {
        var tableBody = document.getElementById("failure-table-body");
        tableBody.innerHTML = '';

        $.ajax({
            method: "GET",
            url: "/get-specific-failures-state",
            data: { SPZ: SPZ, state : 2 },
            success: function(response) {
                if(response === null) {
                    tableBody.innerText = "No failures for selected vehicle."
                    resizePopupToContent(1)
                } else {
                    resizePopupToContent(response.length)
                    failures = response.length
                    failuresIDs = []
                    fails = []
                    var index = 0
                    response.forEach(function (item) {
                        failuresIDs.push(item["FailureID"])
                        fails.push(item["Description"])
                        var row = tableBody.insertRow()

                        var cellDetails = row.insertCell()
                        cellDetails.textContent = item["Description"]

                        var cellAssign = row.insertCell();
                        var checkbox = document.createElement('input')
                        checkbox.type = 'checkbox'
                        checkbox.id = 'ch' + index
                        checkbox.value = "yes"
                        index++
                        cellAssign.appendChild(checkbox)
                    })
                }
            },
            error: function() {
                console.log("ERROR")
            }
        });
    }

    function resizePopupToContent(rows) {
        let popup = document.getElementById('popup');
        let pixels = 450 + rows * 40
        popup.style.height = pixels.toString() + 'px';
    }

    function updateTable(data) {
        var tableBody = document.getElementById("tech-records-tbody")
        var row = tableBody.insertRow()

        var cellSPZ = row.insertCell()
        cellSPZ.textContent = data["SPZ"]

        var cellDate = row.insertCell()
        cellDate.textContent = data["Date"]

        var cellFailure = row.insertCell()
        if (data["FailureDescription"] === null) {
            cellFailure.textContent = "None"
        } else {
            cellFailure.textContent = data["FailureDescription"]
        }
        var cellDetails = row.insertCell()
        cellDetails.textContent = data["Details"]

        var cellAuthorName = row.insertCell()
        cellAuthorName.textContent = data["AuthorName"]

        var cellAuthorSurname = row.insertCell()
        cellAuthorSurname.textContent = data["AuthorSurname"]
    }

    fetchData();
</script>
</body>
</html>