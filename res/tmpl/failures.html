<!DOCTYPE html>
<html>
<head>
    <style>
        .popup-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 500px;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .popup-row {
            margin-bottom: 25px;
        }

        .popup-button {
            padding: 10px;
            background-color: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .popup-table {
            border-collapse: collapse;
            width: 100%;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even){background-color: #f2f2f2}

        th {
            background-color: #D22B2B;
            color: white;
        }
    </style>
</head>
<body>

<h2>Z√°vady üöé</h2><br>

<select name="failures" id="failures">
    <option value="vsechny">V≈°echny</option>
    <option value="prideleno">P≈ôideleno</option>
    <option value="vreseni">V ≈ôe≈°en√≠</option>
    <option value="pozastaveno">Pozastaveno</option>
    <option value="vyreseno">Vy≈ôe≈°eno</option>
</select>

<table id="table-zavady">
    <thead>
        <tr>
            <th>SPZ</th>
            <th>Autor</th>
            <th>Technik</th>
            <th>Popis</th>
            <th>Stav</th>
            <th>Upravit</th>
        </tr>
    </thead>

    <tbody id="table-body">
        {{range .}}
            <tr id="failure{{.FailureID}}">
                <td id="spz{{.FailureID}}">{{.SPZ}}</td>
                <td id="authorSurname{{.FailureID}}">{{.AuthorSurname}}</td>
                <td id="technicianSurname{{.FailureID}}">{{.TechnicianSurname}}</td>
                <td id="description{{.FailureID}}">{{.Description}}</td>
                <td id="state{{.FailureID}}">{{.State}}</td>
                <td><button id="editButton{{.FailureID}}" class="edit-btn" onclick="editFail({{.FailureID}})">‚úèÔ∏è</button></td>
            </tr>
        {{end}}
    </tbody>

</table>
<br>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    var spzData;
    var stateData = [];
    var technicianData = [];
    var technicianMap = new Map()
    var stateMap = new Map()

    function editFail(id) {
        document.getElementById("editButton" + id).textContent = "‚úÖ";
        document.getElementById("editButton" + id).insertAdjacentHTML('afterend', '&nbsp;<button id="deleteButton' + id + '" class="delete-btn" onclick="deleteFail(' + id + ')">‚ùå</button>');

        var spz = document.getElementById("spz" + id);
        var technicianSurname = document.getElementById("technicianSurname" + id);
        var description = document.getElementById("description" + id);
        var state = document.getElementById("state" + id);

        var spzValue = spz.innerText
        var technicianSurnameValue = technicianSurname.innerText
        var descriptionValue = description.innerText
        var stateValue = state.innerText

        document.getElementById("editButton" + id).onclick = function() {
            changeEditState(id)
        }
        sugTarget = "newSpzSuggestion" + id
        verTarget = "newSpzInputStatus" + id
        spz.innerHTML = '<input id="editSpz' + id + '" type="text" value="' + spzValue + '" list="newSpzSuggestion' + id + '" oninput="updateSuggestionsForTarget(this,'+sugTarget+')" onblur="validateSpzForTarget(this.value,'+verTarget+')">' +
            '<datalist id="newSpzSuggestion' + id + '"></datalist>'
            + '<label for="editSpz' + id + '" id="newSpzInputStatus' + id + '">‚ùå</label>'
        technicianSurname.innerHTML = '<select id="editTechnician' + id + '">';
        updateTechnicians("editTechnician" + id)
        description.innerHTML = '<input id="editDescription' + id + '" type="text" value="' + descriptionValue + '">';
        state.innerHTML = '<select id="editState' + id + '"></select>';
        updateStates("editState" + id)

    }

    function updateSuggestionsForTarget(input, target) {
        var inputValue = input.value.toLowerCase();
        target.innerHTML = '';

        var filteredSuggestions = spzData.filter(function (suggestion) {
            return suggestion.toLowerCase().includes(inputValue);
        });

        filteredSuggestions.forEach(function (suggestion) {
            var option = document.createElement('option');
            option.value = suggestion;
            target.appendChild(option);
        });
    }

    function validateSpzForTarget(input, target) {
        $.ajax({
            method: "GET",
            url: "/spz-exists",
            data: { SPZ: input },
            success: function(response) {
                if(response === true) {
                    target.innerHTML = "‚úÖ";
                } else if(response === false) {
                    target.innerHTML = "‚ùå";
                }
            },
            error: function() {
                console.log("ERROR");
            }
        });
    }

    function changeEditState(id){

        document.getElementById("editButton" + id).textContent = "‚úèÔ∏è";

        var deleteButton = document.getElementById("deleteButton" + id);
        if (deleteButton) {
            deleteButton.remove();
        }

        document.getElementById("editButton" + id).onclick = function() {
            editFail(id)
        }


        var spz = document.getElementById("spz" + id);
        var technicianSurname = document.getElementById("technicianSurname" + id);
        var description = document.getElementById("description" + id);
        var state = document.getElementById("state" + id);

        var newSpz = document.getElementById("editSpz" + id);
        var newTechnicianSurname = document.getElementById("editTechnician" + id);
        var newDescription = document.getElementById("editDescription" + id);
        var newState = document.getElementById("editState" + id);

        spz.innerHTML = newSpz.value

        technicianSurname.innerHTML = technicianMap.get(parseInt(newTechnicianSurname.value))
        description.innerHTML = newDescription.value
        state.innerHTML = stateMap.get(parseInt(newState.value))
    }

    function fetchSPZData() {
        console.log("fetchData")
        fetch('/get-spzs')
            .then(response => response.json())
            .then(data => {
                spzData = data
            })
            .catch(error => {
                console.error('Error fetching data:', error)
            });
        console.log("fetchDataDONE")
    }

    function updateStates(target) {
        select = document.getElementById(target)
        stateData.forEach(function (item) {
            var option = document.createElement("option")
            option.value = item["ID"]
            option.innerHTML = item["State"]
            select.appendChild(option)
        })
    }

    function getStates() {
        fetch('/get-states')
            .then(response => response.json())
            .then(data => {
                stateData = data
                data.forEach(function (item) {
                   stateMap.set(item["ID"], item["State"])
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    function updateTechnicians(target) {
        select = document.getElementById(target)
        technicianData.forEach(function (item) {
            var option = document.createElement("option")
            option.value = item["ID"]
            option.innerHTML = item["Name"] + " " + item["Surname"]
            select.appendChild(option)
        });
    }


    function getTechnicians(){
        fetch('/get-technicians')
            .then(response => response.json())
            .then(data => {
                technicianData = data;
                data.forEach(function (item) {
                   technicianMap.set(item["ID"], item["Name"] + " " + item["Surname"])
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    fetchSPZData()
    getStates();
    getTechnicians();
</script>
<button class="create-failure" onclick="openPopupFailures()">‚ûï</button>

<div id="popup" class="popup-container">
    <p>Vytvo≈ôit nov√∫ z√°vadu</p>
    <div class="popup-row">
        <label for="spzInput">SPZ:</label>
        <input type="text" id="spzInput" list="spzSuggestions" placeholder="Zadaj SPZ vozidla" value="" onblur="validateSpz(this.value)" oninput="updateSuggestions(this)">
        <datalist id="spzSuggestions">
        </datalist>
        <label for="spzInput" id="spzInputStatus">‚ùå</label>
    </div>

    <div class="popup-row">
        <label for="technicianInput">Technik:</label>
        <select id="technicianInput">

        </select>
    </div>

    <div class="popup-row">
        <label for="descriptionInput">Popis:</label><br>
        <textarea id="descriptionInput"></textarea>
    </div>

    <div class="popup-row">
        <label for="stateInput">Souƒçasn√Ω stav:</label>
        <select id="stateInput">

        </select>
    </div>

    <button onclick="closePopupFailures()">Zru≈°it</button>
    <button id="create-btn" onclick="create()">Vytvori≈• z√°vadu</button>
</div>

<div id="overlay" class="overlay"></div>

<script>

    let userID = 0;
    let userName = "";
    let userSurname = "";
    technicianNames = new Map();
    let technicianSurnames = new Map();

    function openPopupFailures() {
        document.getElementById('popup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        updateTechnicians("technicianInput")
        updateStates("stateInput")
    }

    function closePopupFailures() {
        clearInputs()
        document.getElementById('popup').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function create() {
        spz = document.getElementById("spzInput").value
        technicianID = parseInt(document.getElementById("technicianInput").value)
        description = document.getElementById("descriptionInput").value
        state = parseInt(document.getElementById("stateInput").value, 10)
        stateDes = stateData[state]["State"]

        $.ajax({
            method: "GET",
            url: "/get-actual-user",
            success: function(response) {
                userID = response["ID"]
                userName = response["Name"]
                userSurname = response["Surname"]
                console.log(technicianNames.get(technicianID))
                $(document).ready(function () {
                    var requestData = {
                        SPZ: spz,
                        AuthorID : userID,
                        AuthorName : userName,
                        AuthorSurname : userSurname,
                        TechnicianID: technicianID,
                        TechnicianName: technicianNames.get(technicianID),
                        TechnicianSurname: technicianSurnames.get(technicianID),
                        Description: description,
                        State: state,
                        StateDescription: stateDes,
                    };

                    $.ajax({
                        type: "POST",
                        url: "/create-new-failure",
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(requestData),
                        success: function (response) {
                            var tableBody = document.getElementById("table-body")
                            var row = tableBody.insertRow()

                            var cellSPZ = row.insertCell()
                            cellSPZ.textContent = response["SPZ"]

                            var cellAuthor = row.insertCell()
                            cellAuthor.textContent = response["AuthorSurname"]

                            var cellTechnician = row.insertCell()
                            cellTechnician.textContent = response["TechnicianSurname"]

                            var cellDescription = row.insertCell()
                            cellDescription.textContent = response["Description"]

                            var cellState = row.insertCell()
                            cellState.textContent = response["StateDescription"]



                            var cellEdit = row.insertCell()
                            cellEdit.innerHTML = '<td><button id="editButton{{.FailureID}}" class="edit-btn" onclick="editFail({{.FailureID}})">‚úèÔ∏è</button></td>'
                        },
                        error: function (error) {
                            console.error("Error:", error);
                        }
                    });
                });
                clearInputs()
                document.getElementById('popup').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            },
            error: function() {
                console.log("ERROR");
            }
        });

    }

    function clearInputs() {
        document.getElementById("spzInput").value = '';
        document.getElementById("technicianInput").value = '';
        document.getElementById("descriptionInput").value = '';
        document.getElementById("stateInput").value = '';
    }

    function updateSuggestions(input) {
        var inputValue = input.value.toLowerCase();
        var dataList = document.getElementById('spzSuggestions');

        dataList.innerHTML = '';

        var filteredSuggestions = spzData.filter(function (suggestion) {
            return suggestion.toLowerCase().includes(inputValue);
        });

        filteredSuggestions.forEach(function (suggestion) {
            var option = document.createElement('option');
            option.value = suggestion;
            dataList.appendChild(option);
        });
    }

    function validateSpz(input) {
        $.ajax({
            method: "GET",
            url: "/spz-exists",
            data: { SPZ: input },
            success: function(response) {
                if(response === true) {
                    document.getElementById("spzInputStatus").innerHTML = "‚úÖ";
                } else if(response === false) {
                    document.getElementById("spzInputStatus").innerHTML = "‚ùå";
                }
            },
            error: function() {
                console.log("ERROR");
            }
        });
    }


    function resizePopupToContent(rows) {
        let popup = document.getElementById('popup');
        let pixels = 450 + rows * 40
        popup.style.height = pixels.toString() + 'px';
    }

</script>

</body>
</html>